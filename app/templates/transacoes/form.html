{% extends "base.html" %}

{% block title %}Nova Transação - Gestão Financeira{% endblock %}

{% block content %}
<h1 class="mb-4">Nova Transação</h1>

<div class="card">
    <div class="card-body">
        <form method="POST">
            <div class="mb-3">
                <label for="descricao" class="form-label">Descrição</label>
                <input type="text" class="form-control" id="descricao" name="descricao" required>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="valor" class="form-label">Valor</label>
                        <input type="number" step="0.01" class="form-control" id="valor"
                               name="valor" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="data" class="form-label">Data</label>
                        <input type="date" class="form-control" id="data" name="data" required value="{{ data_hoje }}">
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="tipo" class="form-label">Tipo</label>
                <select class="form-select" id="tipo" name="tipo" required>
                    <option value="">Selecione...</option>
                    <option value="receita">Receita</option>
                    <option value="despesa">Despesa</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="forma_pagamento" class="form-label">Forma de Pagamento</label>
                <select class="form-select" id="forma_pagamento" name="forma_pagamento" required>
                    <option value="dinheiro">Dinheiro/Débito</option>
                    <option value="cartao_credito">Cartão de Crédito</option>
                </select>
            </div>

            <div class="mb-3" id="campo_conta">
                <label for="conta_id" class="form-label">Conta</label>
                <select class="form-select" id="conta_id" name="conta_id" required>
                    <option value="">Selecione...</option>
                    {% for conta in contas %}
                        <option value="{{ conta.id }}">{{ conta.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3" id="campo_cartao" style="display: none;">
                <label for="cartao_credito_id" class="form-label">Cartão de Crédito</label>
                <select class="form-select" id="cartao_credito_id" name="cartao_credito_id">
                    <option value="">Selecione...</option>
                    {% for cartao in cartoes %}
                        <option value="{{ cartao.id }}">{{ cartao.nome }} ({{ cartao.bandeira }})</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3" id="campo_parcelas" style="display: none;">
                <label for="total_parcelas" class="form-label">Número de Parcelas</label>
                <select class="form-select" id="total_parcelas" name="total_parcelas">
                    <option value="1">À vista</option>
                    {% for i in range(2, 13) %}
                        <option value="{{ i }}">{{ i }}x</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="categoria_busca" class="form-label">Categoria</label>
                <div class="position-relative">
                    <input type="text" class="form-control" id="categoria_busca"
                           placeholder="Digite para buscar ou criar nova categoria..."
                           autocomplete="off">
                    <input type="hidden" id="categoria_id" name="categoria_id">
                    <div id="categoria_sugestoes" class="list-group position-absolute w-100" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;">
                    </div>
                </div>
                <div id="categoria_opcoes" class="mt-2" style="display: none;">
                    <small class="text-muted">Categoria não encontrada.</small>
                    <button type="button" class="btn btn-sm btn-success" id="btn_criar_categoria">
                        <i class="bi bi-plus-circle"></i> Criar nova categoria
                    </button>
                </div>
                <div id="categoria_erro" class="text-danger mt-1" style="display: none;">
                    <small>Por favor, selecione uma categoria válida.</small>
                </div>
            </div>

            <!-- Checkbox para marcar como pago -->
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="pago" name="pago">
                    <label class="form-check-label" for="pago">
                        <i class="bi bi-check-circle"></i> Marcar como pago/recebido
                    </label>
                    <small class="form-text text-muted d-block mt-1">
                        Marque se esta transação já foi efetivada
                    </small>
                </div>
            </div>

            <!-- Seção de Recorrência -->
            <div class="card mb-3" style="background: rgba(0, 102, 255, 0.03); border: 1px solid rgba(0, 102, 255, 0.1);">
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="recorrente" name="recorrente">
                        <label class="form-check-label" for="recorrente" style="font-weight: 600;">
                            <i class="bi bi-arrow-repeat"></i> Transação Recorrente
                        </label>
                        <small class="form-text text-muted d-block mt-1">
                            Marque para criar automaticamente esta transação em intervalos regulares
                        </small>
                    </div>

                    <div id="campos_recorrencia" style="display: none;">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="frequencia_recorrencia" class="form-label">Frequência</label>
                                <select class="form-select" id="frequencia_recorrencia" name="frequencia_recorrencia">
                                    <option value="">Selecione...</option>
                                    <option value="semanal">Semanal</option>
                                    <option value="quinzenal">Quinzenal</option>
                                    <option value="mensal">Mensal</option>
                                    <option value="bimestral">Bimestral</option>
                                    <option value="trimestral">Trimestral</option>
                                    <option value="semestral">Semestral</option>
                                    <option value="anual">Anual</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="data_inicio_recorrencia" class="form-label">Data de Início</label>
                                <input type="date" class="form-control" id="data_inicio_recorrencia"
                                       name="data_inicio_recorrencia" value="{{ data_hoje }}">
                                <small class="form-text text-muted">
                                    Primeira ocorrência
                                </small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="quantidade_recorrencias" class="form-label">Quantidade de Vezes</label>
                                <input type="number" class="form-control" id="quantidade_recorrencias"
                                       name="quantidade_recorrencias" min="1" max="100" value="12">
                                <small class="form-text text-muted">
                                    Número de repetições
                                </small>
                            </div>
                        </div>
                        <div class="alert alert-info" role="alert" style="font-size: 0.9rem; background: rgba(0, 102, 255, 0.05); border-color: rgba(0, 102, 255, 0.2);">
                            <i class="bi bi-info-circle"></i>
                            <strong>Como funciona:</strong> Serão geradas automaticamente <span id="preview_quantidade">12</span> transações
                            conforme a frequência selecionada, começando na data informada.
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Salvar
                </button>
                <a href="{{ url_for('main.listar_transacoes') }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<style>
/* Modal Enhancements */
.modal-content {
    box-shadow: var(--shadow-lg);
}

.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
}

.modal.fade .modal-dialog {
    transition: transform 0.3s ease-out;
}

/* Ensure modal appears above backdrop */
.modal {
    z-index: 1055;
}

.modal-backdrop {
    z-index: 1050;
}

/* Form Label Styling */
.form-label {
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: 0.5rem;
}

/* Autocomplete Suggestions Styling */
#categoria_sugestoes {
    background: var(--color-surface);
    backdrop-filter: blur(20px);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    margin-top: 0.25rem;
}

#categoria_sugestoes .list-group-item {
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--color-border-light);
    transition: all var(--transition-fast);
}

#categoria_sugestoes .list-group-item:last-child {
    border-bottom: none;
}

#categoria_sugestoes .list-group-item:hover {
    background: rgba(0, 102, 255, 0.05);
    transform: translateX(4px);
}
</style>

<!-- Modal para criar categoria -->
<div class="modal fade" id="modalNovaCategoria" tabindex="-1" aria-labelledby="modalNovaCategoriaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--color-surface); backdrop-filter: blur(20px); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg);">
            <div class="modal-header" style="border-bottom: 1px solid var(--color-border-light);">
                <h5 class="modal-title" id="modalNovaCategoriaLabel" style="font-weight: 700;">
                    <i class="bi bi-plus-circle"></i> Nova Categoria
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: var(--space-lg);">
                <div class="mb-3">
                    <label for="nova_categoria_nome" class="form-label">Nome</label>
                    <input type="text" class="form-control" id="nova_categoria_nome" required>
                </div>
                <div class="mb-3">
                    <label for="nova_categoria_tipo" class="form-label">Tipo</label>
                    <select class="form-select" id="nova_categoria_tipo" required>
                        <option value="">Selecione...</option>
                        <option value="receita">Receita</option>
                        <option value="despesa">Despesa</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="nova_categoria_cor" class="form-label">Cor</label>
                    <input type="color" class="form-control form-control-color"
                           id="nova_categoria_cor" value="#3498db">
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--color-border-light); padding: var(--space-md) var(--space-lg);">
                <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn_salvar_categoria">
                    <i class="bi bi-check-circle"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const categoriaBusca = document.getElementById('categoria_busca');
    const categoriaId = document.getElementById('categoria_id');
    const categoriaOpcoes = document.getElementById('categoria_opcoes');
    const categoriaErro = document.getElementById('categoria_erro');
    const btnCriarCategoria = document.getElementById('btn_criar_categoria');
    const modalElement = document.getElementById('modalNovaCategoria');
    const btnSalvarCategoria = document.getElementById('btn_salvar_categoria');
    const tipoTransacao = document.getElementById('tipo');

    // Controles de recorrência
    const recorrenteCheckbox = document.getElementById('recorrente');
    const camposRecorrencia = document.getElementById('campos_recorrencia');
    const frequenciaRecorrencia = document.getElementById('frequencia_recorrencia');
    const dataInicioRecorrencia = document.getElementById('data_inicio_recorrencia');
    const quantidadeRecorrencias = document.getElementById('quantidade_recorrencias');
    const previewQuantidade = document.getElementById('preview_quantidade');

    // Mostrar/ocultar campos de recorrência
    recorrenteCheckbox.addEventListener('change', function() {
        if (this.checked) {
            camposRecorrencia.style.display = 'block';
            frequenciaRecorrencia.setAttribute('required', 'required');
            dataInicioRecorrencia.setAttribute('required', 'required');
            quantidadeRecorrencias.setAttribute('required', 'required');
        } else {
            camposRecorrencia.style.display = 'none';
            frequenciaRecorrencia.removeAttribute('required');
            dataInicioRecorrencia.removeAttribute('required');
            quantidadeRecorrencias.removeAttribute('required');
        }
    });

    // Atualizar preview da quantidade
    quantidadeRecorrencias.addEventListener('input', function() {
        previewQuantidade.textContent = this.value || '0';
    });

    // Initialize Bootstrap Modal
    let modalNovaCategoria;
    try {
        modalNovaCategoria = new bootstrap.Modal(modalElement, {
            backdrop: 'static',
            keyboard: true
        });
    } catch (error) {
        console.error('Error initializing modal:', error);
    }

    // Criar array de categorias para busca
    let categorias = [];
    {% for categoria in categorias %}
    categorias.push({
        id: {{ categoria.id }},
        nome: "{{ categoria.nome }}",
        tipo: "{{ categoria.tipo }}"
    });
    {% endfor %}

    // Validar formulário antes de enviar
    form.addEventListener('submit', function(e) {
        console.log('Submit event triggered');
        console.log('categoria_id value:', categoriaId.value);
        console.log('categoria_busca value:', categoriaBusca.value);

        categoriaErro.style.display = 'none';
        categoriaBusca.classList.remove('is-invalid');

        if (!categoriaId.value || categoriaId.value === '') {
            console.log('Blocking submit - no category selected');
            e.preventDefault();
            e.stopPropagation();
            categoriaErro.style.display = 'block';
            categoriaBusca.classList.add('is-invalid');
            categoriaBusca.focus();
            return false;
        }

        console.log('Form validation passed, submitting...');
        return true;
    });

    const categoriaSugestoes = document.getElementById('categoria_sugestoes');
    const formaPagamento = document.getElementById('forma_pagamento');
    const campoConta = document.getElementById('campo_conta');
    const campoCartao = document.getElementById('campo_cartao');
    const campoParcelas = document.getElementById('campo_parcelas');
    const contaId = document.getElementById('conta_id');
    const cartaoId = document.getElementById('cartao_credito_id');

    // Alternar entre conta e cartão conforme forma de pagamento
    formaPagamento.addEventListener('change', function() {
        if (this.value === 'cartao_credito') {
            campoConta.style.display = 'none';
            campoCartao.style.display = 'block';
            campoParcelas.style.display = 'block';
            contaId.removeAttribute('required');
            cartaoId.setAttribute('required', 'required');
        } else {
            campoConta.style.display = 'block';
            campoCartao.style.display = 'none';
            campoParcelas.style.display = 'none';
            contaId.setAttribute('required', 'required');
            cartaoId.removeAttribute('required');
        }
    });

    // Filtrar categorias por tipo quando o tipo for alterado
    tipoTransacao.addEventListener('change', function() {
        categoriaBusca.value = '';
        categoriaId.value = '';
        categoriaSugestoes.style.display = 'none';
        categoriaBusca.focus();
    });

    // Função para mostrar sugestões
    function mostrarSugestoes(categoriasFiltradas) {
        categoriaSugestoes.innerHTML = '';

        if (categoriasFiltradas.length === 0) {
            categoriaSugestoes.style.display = 'none';
            return;
        }

        categoriasFiltradas.forEach(cat => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'list-group-item list-group-item-action';
            item.textContent = cat.nome;
            item.style.cursor = 'pointer';

            // Badge para mostrar o tipo
            const badge = document.createElement('span');
            badge.className = cat.tipo === 'receita' ? 'badge bg-success float-end' : 'badge bg-danger float-end';
            badge.textContent = cat.tipo === 'receita' ? 'Receita' : 'Despesa';
            item.appendChild(badge);

            item.addEventListener('click', function(e) {
                e.preventDefault();
                categoriaBusca.value = cat.nome;
                categoriaId.value = cat.id;
                categoriaSugestoes.style.display = 'none';
                categoriaOpcoes.style.display = 'none';
                categoriaErro.style.display = 'none';
                categoriaBusca.classList.remove('is-invalid');
            });

            categoriaSugestoes.appendChild(item);
        });

        categoriaSugestoes.style.display = 'block';
    }

    // Buscar categoria enquanto digita
    categoriaBusca.addEventListener('input', function() {
        const busca = this.value.trim().toLowerCase();
        const tipoSelecionado = tipoTransacao.value;

        if (busca === '') {
            categoriaOpcoes.style.display = 'none';
            categoriaId.value = '';
            categoriaSugestoes.style.display = 'none';
            return;
        }

        // Filtrar categorias por tipo e nome
        const categoriasFiltradas = categorias.filter(cat => {
            const matchNome = cat.nome.toLowerCase().includes(busca);
            const matchTipo = !tipoSelecionado || cat.tipo === tipoSelecionado;
            return matchNome && matchTipo;
        });

        // Verificar se há match exato
        const matchExato = categoriasFiltradas.find(cat =>
            cat.nome.toLowerCase() === busca
        );

        if (matchExato) {
            categoriaId.value = matchExato.id;
            categoriaOpcoes.style.display = 'none';
            categoriaSugestoes.style.display = 'none';
            categoriaErro.style.display = 'none';
            categoriaBusca.classList.remove('is-invalid');
        } else if (categoriasFiltradas.length === 0) {
            categoriaId.value = '';
            categoriaOpcoes.style.display = 'block';
            categoriaSugestoes.style.display = 'none';
        } else {
            categoriaId.value = '';
            categoriaOpcoes.style.display = 'none';
            mostrarSugestoes(categoriasFiltradas);
        }
    });

    // Autocompletar ao perder foco
    categoriaBusca.addEventListener('blur', function() {
        setTimeout(() => {
            const busca = this.value.trim().toLowerCase();
            const tipoSelecionado = tipoTransacao.value;

            if (busca) {
                const categoriasFiltradas = categorias.filter(cat => {
                    const matchNome = cat.nome.toLowerCase().includes(busca);
                    const matchTipo = !tipoSelecionado || cat.tipo === tipoSelecionado;
                    return matchNome && matchTipo;
                });

                if (categoriasFiltradas.length === 1) {
                    categoriaBusca.value = categoriasFiltradas[0].nome;
                    categoriaId.value = categoriasFiltradas[0].id;
                    categoriaOpcoes.style.display = 'none';
                    categoriaErro.style.display = 'none';
                    categoriaBusca.classList.remove('is-invalid');
                }
            }

            // Esconder sugestões ao perder foco
            categoriaSugestoes.style.display = 'none';
        }, 200);
    });

    // Focar no campo ao clicar nas sugestões
    categoriaBusca.addEventListener('focus', function() {
        if (this.value.trim() !== '' && categoriaId.value === '') {
            // Re-mostrar sugestões se houver texto mas nenhuma categoria selecionada
            const busca = this.value.trim().toLowerCase();
            const tipoSelecionado = tipoTransacao.value;

            const categoriasFiltradas = categorias.filter(cat => {
                const matchNome = cat.nome.toLowerCase().includes(busca);
                const matchTipo = !tipoSelecionado || cat.tipo === tipoSelecionado;
                return matchNome && matchTipo;
            });

            if (categoriasFiltradas.length > 0) {
                mostrarSugestoes(categoriasFiltradas);
            }
        }
    });

    // Criar nova categoria
    btnCriarCategoria.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        console.log('Opening modal...');

        const nomeBusca = categoriaBusca.value.trim();
        document.getElementById('nova_categoria_nome').value = nomeBusca;

        // Pre-selecionar o tipo se já estiver escolhido
        const tipoSelecionado = tipoTransacao.value;
        if (tipoSelecionado) {
            document.getElementById('nova_categoria_tipo').value = tipoSelecionado;
        }

        // Show modal
        try {
            if (modalNovaCategoria) {
                modalNovaCategoria.show();
            } else {
                console.error('Modal not initialized');
                // Fallback: try to show modal directly with Bootstrap
                const modalEl = document.getElementById('modalNovaCategoria');
                if (modalEl) {
                    modalEl.classList.add('show');
                    modalEl.style.display = 'block';
                    document.body.classList.add('modal-open');

                    // Create backdrop
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    backdrop.id = 'modal-backdrop-temp';
                    document.body.appendChild(backdrop);
                }
            }
        } catch (error) {
            console.error('Error showing modal:', error);
            alert('Erro ao abrir o modal. Por favor, recarregue a página.');
        }
    });

    // Salvar nova categoria
    btnSalvarCategoria.addEventListener('click', async function() {
        const nome = document.getElementById('nova_categoria_nome').value.trim();
        const tipo = document.getElementById('nova_categoria_tipo').value;
        const cor = document.getElementById('nova_categoria_cor').value;

        if (!nome || !tipo) {
            alert('Por favor, preencha todos os campos obrigatórios.');
            return;
        }

        try {
            const response = await fetch('/api/categorias', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ nome, tipo, cor })
            });

            if (response.ok) {
                const novaCategoria = await response.json();

                // Adicionar à lista de categorias
                categorias.push({
                    id: novaCategoria.id,
                    nome: novaCategoria.nome,
                    tipo: novaCategoria.tipo
                });

                // Atualizar o campo
                categoriaBusca.value = novaCategoria.nome;
                categoriaId.value = novaCategoria.id;
                categoriaOpcoes.style.display = 'none';
                categoriaErro.style.display = 'none';
                categoriaBusca.classList.remove('is-invalid');
                categoriaSugestoes.style.display = 'none';

                // Fechar modal
                if (modalNovaCategoria) {
                    modalNovaCategoria.hide();
                } else {
                    // Fallback: close manually
                    const modalEl = document.getElementById('modalNovaCategoria');
                    if (modalEl) {
                        modalEl.classList.remove('show');
                        modalEl.style.display = 'none';
                        document.body.classList.remove('modal-open');

                        // Remove backdrop
                        const backdrop = document.getElementById('modal-backdrop-temp');
                        if (backdrop) {
                            backdrop.remove();
                        }
                    }
                }

                // Limpar form
                document.getElementById('nova_categoria_nome').value = '';
                document.getElementById('nova_categoria_tipo').value = '';
                document.getElementById('nova_categoria_cor').value = '#3498db';
            } else {
                const error = await response.json();
                alert('Erro ao criar categoria: ' + (error.erro || 'Erro desconhecido'));
            }
        } catch (error) {
            alert('Erro ao criar categoria: ' + error.message);
        }
    });

    // Handle modal close buttons
    const modalCloseButtons = modalElement.querySelectorAll('[data-bs-dismiss="modal"]');
    modalCloseButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            if (modalNovaCategoria) {
                modalNovaCategoria.hide();
            } else {
                // Fallback
                modalElement.classList.remove('show');
                modalElement.style.display = 'none';
                document.body.classList.remove('modal-open');

                const backdrop = document.getElementById('modal-backdrop-temp');
                if (backdrop) {
                    backdrop.remove();
                }
            }
        });
    });
});
</script>

{% endblock %}
