{% extends "base.html" %}

{% block title %}Editar Transação - Gestão Financeira{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="d-flex justify-content-between align-items-center mb-4" style="margin-top: 2rem;">
    <div>
        <h1 style="margin-bottom: 0.5rem;">Editar Transação</h1>
        <p class="text-muted" style="margin: 0; font-size: 0.95rem;">Atualize os detalhes da transação</p>
    </div>
    <a href="{{ url_for('main.listar_transacoes') }}" class="btn btn-outline">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
</div>

<div class="card">
    <div class="card-header">
        <h5><i class="bi bi-pencil"></i> Formulário de Edição</h5>
    </div>
    <div class="card-body">
        <form method="POST">
            <!-- Informações sobre Parcelamento (se aplicável) -->
            {% if transacao.parcelado %}
            <div class="alert alert-info mb-4" style="background: rgba(0, 102, 255, 0.08); border: 1px solid rgba(0, 102, 255, 0.2); border-radius: var(--radius-md);">
                <i class="bi bi-info-circle"></i> <strong>Transação Parcelada</strong><br>
                <small>Esta é a parcela {{ transacao.numero_parcela }} de {{ transacao.total_parcelas }}.
                Os campos de parcelamento não podem ser editados.</small>
            </div>
            {% endif %}

            <!-- Descrição -->
            <div class="mb-3">
                <label for="descricao" class="form-label">Descrição</label>
                <input type="text" class="form-control" id="descricao" name="descricao"
                       value="{{ transacao.descricao }}" required>
            </div>

            <!-- Linha 1: Valor e Data -->
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="valor" class="form-label">Valor</label>
                        <input type="number" step="0.01" class="form-control" id="valor"
                               name="valor" value="{{ transacao.valor }}" required
                               style="font-family: var(--font-mono); font-weight: 600;">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="data" class="form-label">Data</label>
                        <input type="date" class="form-control" id="data" name="data"
                               value="{{ transacao.data.strftime('%Y-%m-%d') }}" required>
                    </div>
                </div>
            </div>

            <!-- Linha 2: Tipo e Categoria -->
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="tipo" class="form-label">Tipo</label>
                        <select class="form-select" id="tipo" name="tipo" required>
                            <option value="">Selecione...</option>
                            <option value="receita" {% if transacao.tipo == 'receita' %}selected{% endif %}>Receita</option>
                            <option value="despesa" {% if transacao.tipo == 'despesa' %}selected{% endif %}>Despesa</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="categoria_id" class="form-label">Categoria</label>
                        <select class="form-select" id="categoria_id" name="categoria_id" required>
                            <option value="">Selecione...</option>
                            {% for categoria in categorias %}
                                <option value="{{ categoria.id }}" {% if categoria.id == transacao.categoria_id %}selected{% endif %}>
                                    {{ categoria.nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Conta -->
            <div class="mb-3">
                <label for="conta_id" class="form-label">Conta</label>
                <select class="form-select" id="conta_id" name="conta_id" required>
                    <option value="">Selecione...</option>
                    {% for conta in contas %}
                        <option value="{{ conta.id }}" {% if conta.id == transacao.conta_id %}selected{% endif %}>
                            {{ conta.nome }} - Saldo: R$ {{ "%.2f"|format(conta.saldo_atual) }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Forma de Pagamento -->
            <div class="mb-3">
                <label for="forma_pagamento" class="form-label">Forma de Pagamento</label>
                <select class="form-select" id="forma_pagamento" name="forma_pagamento" onchange="toggleCartaoCredito()">
                    <option value="dinheiro" {% if transacao.forma_pagamento == 'dinheiro' %}selected{% endif %}>Dinheiro</option>
                    <option value="cartao_credito" {% if transacao.forma_pagamento == 'cartao_credito' %}selected{% endif %}>Cartão de Crédito</option>
                </select>
            </div>

            <!-- Cartão de Crédito (condicional) -->
            <div class="mb-3" id="cartao-container" style="display: {% if transacao.forma_pagamento == 'cartao_credito' %}block{% else %}none{% endif %};">
                <label for="cartao_credito_id" class="form-label">Cartão de Crédito</label>
                <select class="form-select" id="cartao_credito_id" name="cartao_credito_id">
                    <option value="">Selecione...</option>
                    {% for cartao in cartoes %}
                        <option value="{{ cartao.id }}" {% if cartao.id == transacao.cartao_credito_id %}selected{% endif %}>
                            {{ cartao.nome }} - Limite Disponível: R$ {{ "%.2f"|format(cartao.limite_disponivel()) }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Status de Pago/Recebido (apenas para não-cartão) -->
            <div class="mb-4" id="pago-container" style="display: {% if transacao.forma_pagamento != 'cartao_credito' %}block{% else %}none{% endif %};">
                <div class="form-check" style="padding: var(--space-md); background: rgba(0, 208, 132, 0.05); border-radius: var(--radius-md); border: 1px solid rgba(0, 208, 132, 0.2);">
                    <input class="form-check-input" type="checkbox" id="pago" name="pago"
                           {% if transacao.pago %}checked{% endif %}
                           style="width: 1.2em; height: 1.2em;">
                    <label class="form-check-label" for="pago" style="margin-left: 0.5rem; font-weight: 500;">
                        {% if transacao.tipo == 'receita' %}
                            <i class="bi bi-check-circle"></i> Marcar como Recebido
                        {% else %}
                            <i class="bi bi-check-circle"></i> Marcar como Pago
                        {% endif %}
                    </label>
                </div>
                <small class="text-muted" style="display: block; margin-top: 0.5rem;">
                    <i class="bi bi-info-circle"></i> Transações de cartão de crédito são pagas através da fatura
                </small>
            </div>

            <!-- Botões de Ação -->
            <div class="d-flex gap-2" style="padding-top: var(--space-md); border-top: 1px solid var(--color-border-light);">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Salvar Alterações
                </button>
                <a href="{{ url_for('main.listar_transacoes') }}" class="btn btn-outline">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<style>
/* Form Enhancements */
.form-label {
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    padding: 0.625rem 0.875rem;
    transition: all var(--transition-fast);
}

.form-control:focus, .form-select:focus {
    border-color: var(--color-accent-blue);
    box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
}

.form-check-input:checked {
    background-color: var(--color-accent-green);
    border-color: var(--color-accent-green);
}

.alert {
    padding: var(--space-md);
}
</style>

<script>
// Toggle Credit Card Field
function toggleCartaoCredito() {
    const formaPagamento = document.getElementById('forma_pagamento').value;
    const cartaoContainer = document.getElementById('cartao-container');
    const pagoContainer = document.getElementById('pago-container');
    const cartaoSelect = document.getElementById('cartao_credito_id');

    if (formaPagamento === 'cartao_credito') {
        cartaoContainer.style.display = 'block';
        pagoContainer.style.display = 'none';
        cartaoSelect.required = true;
    } else {
        cartaoContainer.style.display = 'none';
        pagoContainer.style.display = 'block';
        cartaoSelect.required = false;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleCartaoCredito();
});
</script>
{% endblock %}
