{% extends "base.html" %}

{% block title %}Dashboard - Gestão Financeira{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="d-flex justify-content-between align-items-center mb-4" style="margin-top: 2rem;">
    <div>
        <h1 style="margin-bottom: 0.5rem;">Projeção de Fluxo de Caixa</h1>
        <p class="text-muted" style="margin: 0; font-size: 0.95rem;">Acompanhe sua saúde financeira em tempo real</p>
    </div>
    <form method="GET" class="d-flex gap-2">
        <select name="mes" class="form-select form-select-sm" style="width: 140px;" onchange="this.form.submit()">
            {% for i in range(1, 13) %}
                <option value="{{ i }}" {% if i == mes_filtro %}selected{% endif %}>
                    {{ ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][i-1] }}
                </option>
            {% endfor %}
        </select>
        <select name="ano" class="form-select form-select-sm" style="width: 100px;" onchange="this.form.submit()">
            {% for ano in range(2020, 2030) %}
                <option value="{{ ano }}" {% if ano == ano_filtro %}selected{% endif %}>{{ ano }}</option>
            {% endfor %}
        </select>
    </form>
</div>

<!-- KPI Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card metric-card metric-blue">
            <h5 class="card-title">
                <i class="bi bi-wallet"></i> Saldo Atual
            </h5>
            <div class="metric-value">R$ {{ "%.2f"|format(saldo_total) }}</div>
            <div class="metric-label">Todas as contas</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card metric-green">
            <h5 class="card-title">
                <i class="bi bi-arrow-down-circle"></i> Receitas
            </h5>
            <div class="metric-value">R$ {{ "%.2f"|format(receitas_mes) }}</div>
            <div class="metric-label">Total do mês</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card metric-red">
            <h5 class="card-title">
                <i class="bi bi-arrow-up-circle"></i> Despesas
            </h5>
            <div class="metric-value">R$ {{ "%.2f"|format(despesas_mes) }}</div>
            <div class="metric-label">Total do mês</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card metric-orange">
            <h5 class="card-title">
                <i class="bi bi-graph-up-arrow"></i> Saldo Previsto
            </h5>
            <div class="metric-value">R$ {{ "%.2f"|format(saldo_previsto) }}</div>
            <div class="metric-label">Fim do mês</div>
        </div>
    </div>
</div>

<!-- Cash Flow Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-graph-up"></i> Fluxo de Caixa - {{ mes_filtro }}/{{ ano_filtro }}</h5>
            </div>
            <div class="card-body">
                <div id="fluxoCaixaChart" style="width: 100%; height: 450px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Lists Section -->
<div class="row mb-4">
    <!-- Upcoming Payments -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-calendar-x"></i> Próximos Pagamentos</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for pagamento in proximos_pagamentos %}
                        <div class="list-group-item d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                    {% if pagamento.tipo == 'fatura' %}
                                        <i class="bi bi-credit-card" style="color: var(--color-accent-purple);"></i>
                                    {% else %}
                                        <i class="bi bi-cash-stack" style="color: var(--color-accent-red);"></i>
                                    {% endif %}
                                    <strong style="font-size: 1rem; color: var(--color-text-primary);">
                                        {{ pagamento.descricao }}
                                    </strong>
                                </div>
                                <small class="text-muted" style="display: block; margin-left: 1.75rem;">
                                    {{ pagamento.categoria }} • {{ pagamento.data.strftime('%d/%m/%Y') }}
                                </small>
                            </div>
                            <div style="text-align: right; margin-left: 1rem; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                                <span class="financial-value negative" style="font-size: 1.1rem; white-space: nowrap;">
                                    R$ {{ "%.2f"|format(pagamento.valor) }}
                                </span>
                                {% if pagamento.tipo == 'fatura' %}
                                    <a href="{{ url_for('main.ver_fatura', id=pagamento.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> Ver Fatura
                                    </a>
                                {% else %}
                                    {% if not pagamento.pago %}
                                        <button class="btn btn-sm btn-success btn-marcar-pago"
                                                data-id="{{ pagamento.id }}"
                                                data-tipo="despesa">
                                            <i class="bi bi-check-circle"></i> Marcar como Pago
                                        </button>
                                    {% else %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle-fill"></i> Pago
                                        </span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-check-circle-fill" style="font-size: 3rem; color: var(--color-accent-green); opacity: 0.3;"></i>
                            <p class="text-muted mt-3">Nenhum pagamento previsto</p>
                        </div>
                    {% endfor %}
                </div>
                {% if proximos_pagamentos|length > 0 %}
                <a href="{{ url_for('main.listar_transacoes') }}" class="btn btn-outline w-100 mt-3">
                    <i class="bi bi-eye"></i> Ver Todas as Transações
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Upcoming Revenues -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-calendar-check"></i> Próximas Receitas</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for receita in proximas_receitas %}
                        <div class="list-group-item d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                    <i class="bi bi-arrow-down-circle-fill" style="color: var(--color-accent-green);"></i>
                                    <strong style="font-size: 1rem; color: var(--color-text-primary);">
                                        {{ receita.descricao }}
                                    </strong>
                                </div>
                                <small class="text-muted" style="display: block; margin-left: 1.75rem;">
                                    {{ receita.categoria }} • {{ receita.data.strftime('%d/%m/%Y') }}
                                </small>
                            </div>
                            <div style="text-align: right; margin-left: 1rem; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                                <span class="financial-value positive" style="font-size: 1.1rem; white-space: nowrap;">
                                    R$ {{ "%.2f"|format(receita.valor) }}
                                </span>
                                {% if not receita.pago %}
                                    <button class="btn btn-sm btn-success btn-marcar-pago"
                                            data-id="{{ receita.id }}"
                                            data-tipo="receita">
                                        <i class="bi bi-check-circle"></i> Marcar como Recebido
                                    </button>
                                {% else %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle-fill"></i> Recebido
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-inbox" style="font-size: 3rem; color: var(--color-text-tertiary); opacity: 0.3;"></i>
                            <p class="text-muted mt-3">Nenhuma receita prevista</p>
                        </div>
                    {% endfor %}
                </div>
                {% if proximas_receitas|length > 0 %}
                <a href="{{ url_for('main.listar_transacoes') }}" class="btn btn-outline w-100 mt-3">
                    <i class="bi bi-eye"></i> Ver Todas as Transações
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Lembretes e Alertas Section -->
<div class="row mb-4">
    <!-- Lembretes de Metas -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-trophy"></i> Lembretes de Metas</h5>
                <a href="{{ url_for('main.listar_metas') }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i> Ver Todas
                </a>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for lembrete in lembretes_metas %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div style="flex: 1;">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        {% if lembrete.urgencia == 'alta' %}
                                            <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                                        {% elif lembrete.urgencia == 'media' %}
                                            <i class="bi bi-exclamation-circle-fill text-warning"></i>
                                        {% else %}
                                            <i class="bi bi-check-circle-fill text-success"></i>
                                        {% endif %}
                                        <strong>{{ lembrete.titulo }}</strong>
                                    </div>
                                    <small class="text-muted">
                                        Prazo: {{ lembrete.data_fim.strftime('%d/%m/%Y') }}
                                        {% if lembrete.meses_restantes > 0 %}
                                            ({{ lembrete.meses_restantes }} meses restantes)
                                        {% else %}
                                            (prazo vencido)
                                        {% endif %}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <span class="badge
                                        {% if lembrete.status == 'atrasado' %}bg-danger
                                        {% elif lembrete.status == 'atencao' %}bg-warning
                                        {% elif lembrete.status == 'concluida' %}bg-success
                                        {% else %}bg-info{% endif %}">
                                        {{ lembrete.percentual }}%
                                    </span>
                                </div>
                            </div>

                            <!-- Barra de progresso -->
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar
                                    {% if lembrete.status == 'atrasado' %}bg-danger
                                    {% elif lembrete.status == 'atencao' %}bg-warning
                                    {% elif lembrete.status == 'concluida' %}bg-success
                                    {% else %}bg-info{% endif %}"
                                    role="progressbar"
                                    style="width: {{ lembrete.percentual }}%"
                                    aria-valuenow="{{ lembrete.percentual }}"
                                    aria-valuemin="0"
                                    aria-valuemax="100">
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    R$ {{ "%.2f"|format(lembrete.acumulado) }} de R$ {{ "%.2f"|format(lembrete.alvo) }}
                                </small>
                                {% if lembrete.faltante > 0 %}
                                    <small class="text-muted">
                                        Falta: <strong class="text-danger">R$ {{ "%.2f"|format(lembrete.faltante) }}</strong>
                                    </small>
                                {% endif %}
                            </div>

                            {% if lembrete.aporte_sugerido > 0 and lembrete.status != 'concluida' %}
                                <div class="alert alert-info mt-2 mb-0 py-2 px-3" style="font-size: 0.85rem;">
                                    <i class="bi bi-lightbulb"></i>
                                    <strong>Sugestão:</strong> Aporte R$ {{ "%.2f"|format(lembrete.aporte_sugerido) }}/mês
                                    para atingir a meta no prazo.
                                </div>
                            {% endif %}

                            <div class="mt-2">
                                <a href="{{ url_for('main.ver_meta', id=lembrete.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-piggy-bank"></i> Fazer Aporte
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-trophy" style="font-size: 3rem; color: var(--color-text-tertiary); opacity: 0.3;"></i>
                            <p class="text-muted mt-3">Nenhuma meta ativa</p>
                            <a href="{{ url_for('main.nova_meta') }}" class="btn btn-sm btn-primary">
                                <i class="bi bi-plus-circle"></i> Criar Meta
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas de Orçamentos -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-calculator"></i> Alertas de Orçamentos</h5>
                <a href="{{ url_for('main.listar_orcamentos') }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i> Ver Todos
                </a>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for alerta in alertas_orcamentos %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div style="flex: 1;">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        {% if alerta.status == 'excedido' %}
                                            <i class="bi bi-x-octagon-fill text-danger"></i>
                                        {% else %}
                                            <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                                        {% endif %}
                                        <strong>{{ alerta.categoria }}</strong>
                                    </div>
                                    <small class="text-muted">
                                        {% if alerta.status == 'excedido' %}
                                            Orçamento excedido!
                                        {% else %}
                                            Atenção: próximo do limite
                                        {% endif %}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <span class="badge {% if alerta.status == 'excedido' %}bg-danger{% else %}bg-warning{% endif %}">
                                        {{ alerta.percentual }}%
                                    </span>
                                </div>
                            </div>

                            <!-- Barra de progresso -->
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar {% if alerta.status == 'excedido' %}bg-danger{% else %}bg-warning{% endif %}"
                                    role="progressbar"
                                    style="width: {{ [alerta.percentual, 100]|min }}%"
                                    aria-valuenow="{{ alerta.percentual }}"
                                    aria-valuemin="0"
                                    aria-valuemax="100">
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    Gasto: <strong class="text-danger">R$ {{ "%.2f"|format(alerta.gasto) }}</strong>
                                </small>
                                <small class="text-muted">
                                    Limite: R$ {{ "%.2f"|format(alerta.limite) }}
                                </small>
                            </div>

                            {% if alerta.disponivel < 0 %}
                                <div class="alert alert-danger mt-2 mb-0 py-2 px-3" style="font-size: 0.85rem;">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>Atenção:</strong> Você excedeu o orçamento em
                                    R$ {{ "%.2f"|format(alerta.disponivel * -1) }}!
                                </div>
                            {% else %}
                                <div class="alert alert-warning mt-2 mb-0 py-2 px-3" style="font-size: 0.85rem;">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>Disponível:</strong> R$ {{ "%.2f"|format(alerta.disponivel) }}
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-check-circle-fill" style="font-size: 3rem; color: var(--color-accent-green); opacity: 0.3;"></i>
                            <p class="text-muted mt-3">Todos os orçamentos estão dentro do limite</p>
                            <a href="{{ url_for('main.novo_orcamento') }}" class="btn btn-sm btn-primary">
                                <i class="bi bi-plus-circle"></i> Criar Orçamento
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bank Accounts Section -->
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-bank"></i> Contas Bancárias</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for conta in contas %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong style="font-size: 1rem; color: var(--color-text-primary);">{{ conta.nome }}</strong>
                                <br>
                                <small class="text-muted" style="text-transform: capitalize;">{{ conta.tipo }}</small>
                            </div>
                            <span class="badge bg-primary">
                                R$ {{ "%.2f"|format(conta.saldo_atual) }}
                            </span>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-inbox" style="font-size: 3rem; color: var(--color-text-tertiary); opacity: 0.3;"></i>
                            <p class="text-muted mt-3">Nenhuma conta cadastrada</p>
                        </div>
                    {% endfor %}
                </div>
                <a href="{{ url_for('main.nova_conta') }}" class="btn btn-primary mt-3 w-100">
                    <i class="bi bi-plus-circle"></i> Nova Conta
                </a>
            </div>
        </div>
    </div>

    <!-- Pending Invoices -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-receipt"></i> Faturas Pendentes</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for fatura in faturas_abertas[:5] %}
                        <a href="{{ url_for('main.ver_fatura', id=fatura.id) }}"
                           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <strong style="font-size: 1rem; color: var(--color-text-primary);">{{ fatura.cartao.nome }}</strong>
                                <br>
                                <small class="text-muted">
                                    {{ fatura.mes_referencia }}/{{ fatura.ano_referencia }} -
                                    Venc: {{ fatura.data_vencimento.strftime('%d/%m/%Y') }}
                                </small>
                            </div>
                            <span class="badge bg-warning">
                                R$ {{ "%.2f"|format(fatura.valor_total) }}
                            </span>
                        </a>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-check-circle" style="font-size: 3rem; color: var(--color-accent-green); opacity: 0.3;"></i>
                            <p class="text-muted mt-3">Nenhuma fatura pendente</p>
                        </div>
                    {% endfor %}
                </div>
                <a href="{{ url_for('main.listar_faturas') }}" class="btn btn-primary mt-3 w-100">
                    <i class="bi bi-eye"></i> Ver Todas as Faturas
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-lightning-charge"></i> Ações Rápidas</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3 col-sm-6">
                        <a href="{{ url_for('main.nova_transacao') }}" class="btn btn-success w-100" style="padding: 1rem;">
                            <i class="bi bi-cash-coin" style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;"></i>
                            <span style="font-size: 0.9rem;">Nova Transação</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <a href="{{ url_for('main.novo_cartao') }}" class="btn btn-info w-100" style="padding: 1rem;">
                            <i class="bi bi-credit-card" style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;"></i>
                            <span style="font-size: 0.9rem;">Novo Cartão</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <a href="{{ url_for('main.nova_fatura') }}" class="btn btn-warning w-100" style="padding: 1rem;">
                            <i class="bi bi-receipt" style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;"></i>
                            <span style="font-size: 0.9rem;">Nova Fatura</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <a href="{{ url_for('main.relatorios') }}" class="btn btn-primary w-100" style="padding: 1rem;">
                            <i class="bi bi-graph-up" style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;"></i>
                            <span style="font-size: 0.9rem;">Ver Relatórios</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Page-specific enhancements */
.metric-card {
    cursor: default;
}

.list-group-item strong {
    font-weight: 600;
}

/* Empty state icons */
.bi-inbox,
.bi-check-circle {
    opacity: 0.3;
}

/* Payment/Revenue items */
.list-group-item {
    padding: var(--space-md);
}

.list-group-item i {
    flex-shrink: 0;
}
</style>

<script>
// Função para marcar transação como paga/recebida
document.addEventListener('DOMContentLoaded', function() {
    // Adicionar evento aos botões de marcar como pago
    document.querySelectorAll('.btn-marcar-pago').forEach(button => {
        button.addEventListener('click', async function() {
            const transacaoId = this.dataset.id;
            const tipo = this.dataset.tipo;
            const botao = this;

            // Confirmar ação
            const textoConfirmacao = tipo === 'receita'
                ? 'Deseja marcar esta receita como recebida?'
                : 'Deseja marcar esta despesa como paga?';

            if (!confirm(textoConfirmacao)) {
                return;
            }

            // Desabilitar botão durante o processamento
            botao.disabled = true;
            botao.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processando...';

            try {
                const response = await fetch(`/transacoes/${transacaoId}/toggle-pago`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Recarregar a página para atualizar os dados
                    location.reload();
                } else {
                    alert('Erro: ' + data.message);
                    botao.disabled = false;
                    const textoOriginal = tipo === 'receita'
                        ? '<i class="bi bi-check-circle"></i> Marcar como Recebido'
                        : '<i class="bi bi-check-circle"></i> Marcar como Pago';
                    botao.innerHTML = textoOriginal;
                }
            } catch (error) {
                alert('Erro ao processar transação: ' + error.message);
                botao.disabled = false;
                const textoOriginal = tipo === 'receita'
                    ? '<i class="bi bi-check-circle"></i> Marcar como Recebido'
                    : '<i class="bi bi-check-circle"></i> Marcar como Pago';
                botao.innerHTML = textoOriginal;
            }
        });
    });
});

// Aguardar carregamento completo da página e do Plotly
document.addEventListener('DOMContentLoaded', function() {
    // Preparar dados para o gráfico
    var projecaoData = {{ projecao_fluxo | tojson }};

    console.log('Dados de projeção:', projecaoData); // Debug

    // Verificar se Plotly está disponível
    if (typeof Plotly === 'undefined') {
        console.error('Plotly não está carregado. Tentando novamente...');
        // Aguardar um pouco mais e tentar novamente
        setTimeout(initChart, 500);
        return;
    }

    initChart();

    function initChart() {
        // Verificar novamente se Plotly está disponível
        if (typeof Plotly === 'undefined') {
            console.error('Plotly ainda não está disponível');
            document.getElementById('fluxoCaixaChart').innerHTML = '<div style="text-align: center; padding: 50px; color: #ff3b57;">Erro: Biblioteca de gráficos não carregada. Recarregue a página.</div>';
            return;
        }

        // Verificar se há dados
        if (!projecaoData || projecaoData.length === 0) {
            console.error('Nenhum dado de projeção disponível');
            document.getElementById('fluxoCaixaChart').innerHTML = '<div style="text-align: center; padding: 50px; color: #8b98a5;">Nenhum dado disponível para exibir o gráfico</div>';
            return;
        }
    // Extrair dados para o gráfico
    var dias = [];
    var receitas = [];
    var despesas = [];
    var saldos = [];

    projecaoData.forEach(function(item) {
        dias.push(item.dia);
        receitas.push(item.receitas);
        despesas.push(item.despesas);
        saldos.push(item.saldo);
    });

    // Preparar traces
    var data = [];

    // Linha de referência no zero
    if (dias.length > 0) {
        var traceZero = {
            x: [dias[0], dias[dias.length - 1]],
            y: [0, 0],
            type: 'scatter',
            mode: 'lines',
            name: 'Linha Zero',
            line: {
                color: '#8b98a5',
                width: 1,
                dash: 'dash'
            },
            hoverinfo: 'skip',
            showlegend: false
        };
        data.push(traceZero);
    }

    // Trace de Receitas
    var traceReceitas = {
        x: dias,
        y: receitas,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Recebimentos',
        line: {
            color: '#10b981',
            width: 2
        },
        marker: {
            color: '#10b981',
            size: 5
        },
        hovertemplate: '<b>Dia %{x}</b><br>Recebimentos: R$ %{y:.2f}<extra></extra>'
    };
    data.push(traceReceitas);

    // Trace de Despesas
    var traceDespesas = {
        x: dias,
        y: despesas,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Despesas',
        line: {
            color: '#ff3b57',
            width: 2
        },
        marker: {
            color: '#ff3b57',
            size: 5
        },
        hovertemplate: '<b>Dia %{x}</b><br>Despesas: R$ %{y:.2f}<extra></extra>'
    };
    data.push(traceDespesas);

    // Trace de Saldo
    var traceSaldo = {
        x: dias,
        y: saldos,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Saldo',
        line: {
            color: '#0066ff',
            width: 3
        },
        marker: {
            color: '#0066ff',
            size: 6
        },
        hovertemplate: '<b>Dia %{x}</b><br>Saldo: R$ %{y:.2f}<extra></extra>'
    };
    data.push(traceSaldo);

    var layout = {
        font: {
            family: 'Inter, sans-serif',
            size: 12,
            color: '#0f1419'
        },
        hovermode: 'x unified',
        xaxis: {
            title: {
                text: 'Dia do Mês',
                font: {
                    size: 13,
                    weight: 600
                }
            },
            showgrid: true,
            gridcolor: 'rgba(0, 0, 0, 0.06)',
            zeroline: false
        },
        yaxis: {
            title: {
                text: 'Valor (R$)',
                font: {
                    size: 13,
                    weight: 600
                }
            },
            showgrid: true,
            gridcolor: 'rgba(0, 0, 0, 0.06)',
            zeroline: true,
            zerolinecolor: '#8b98a5',
            zerolinewidth: 1
        },
        plot_bgcolor: 'rgba(255, 255, 255, 0.5)',
        paper_bgcolor: 'transparent',
        margin: {
            l: 60,
            r: 30,
            t: 30,
            b: 50
        },
        legend: {
            orientation: 'h',
            yanchor: 'bottom',
            y: 1.02,
            xanchor: 'right',
            x: 1,
            bgcolor: 'rgba(255, 255, 255, 0.8)',
            bordercolor: 'rgba(0, 0, 0, 0.1)',
            borderwidth: 1
        }
    };

    var config = {
        responsive: true,
        displayModeBar: false
    };

        try {
            Plotly.newPlot('fluxoCaixaChart', data, layout, config);
            console.log('Gráfico criado com sucesso');

            // Redimensionar gráfico quando a janela mudar de tamanho
            window.addEventListener('resize', function() {
                Plotly.Plots.resize('fluxoCaixaChart');
            });
        } catch (error) {
            console.error('Erro ao criar gráfico:', error);
            document.getElementById('fluxoCaixaChart').innerHTML = '<div style="text-align: center; padding: 50px; color: #ff3b57;">Erro ao criar gráfico: ' + error.message + '</div>';
        }
    }
});
</script>
{% endblock %}
